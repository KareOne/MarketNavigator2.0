# MarketNavigator v2 - Production Docker Compose Override
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  # ==========================================================================
  # Nginx Reverse Proxy with SSL
  # ==========================================================================
  nginx:
    build: ./nginx
    container_name: mn2-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - letsencrypt_data:/etc/letsencrypt
    depends_on:
      - frontend
      - backend
    restart: unless-stopped
    networks:
      - default

  # ==========================================================================
  # Backend Production Overrides
  # ==========================================================================
  backend:
    environment:
      # Security - Production Settings
      - DEBUG=0
      - SECRET_KEY=${SECRET_KEY:-change-this-to-a-strong-secret-key}

      # Database - Private Network (faster, more secure)
      - DB_HOST=marketnavigator-v2
      - DB_PORT=5432
      - DB_NAME=postgres
      - DB_USER=root
      - DB_PASSWORD=AZ6t2MguosDdJ8oCval6B7bU

      # Domain Configuration
      - ALLOWED_HOSTS=marketnavigator.ir,backend,localhost
      - CORS_ALLOWED_ORIGINS=https://marketnavigator.ir

      # Redis (internal network)
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0

      # S3 Storage (MinIO - use public URL for production)
      - USE_S3=True
      - AWS_ACCESS_KEY_ID=minioadmin
      - AWS_SECRET_ACCESS_KEY=minioadmin123
      - AWS_STORAGE_BUCKET_NAME=marketnavigator-files
      - AWS_S3_ENDPOINT_URL=http://minio:9000

      # Liara AI
      - LIARA_API_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJrZXkiOiI2OTE4MzY0YjFmYjc4MTI5ZDI5MjhiYjgiLCJ0eXBlIjoiYWlfa2V5IiwiaWF0IjoxNzYzMTk0NDQzfQ.SCiUegAiSgB1sscxzNh4TWLZ7KntbZRLk2HGjeA3j0k
      - LIARA_BASE_URL=https://ai.liara.ir/api/6918348a8376cb0a3e18fdef/v1
      - LIARA_MODEL=google/gemini-2.5-flash

      # Scraper APIs (internal network)
      - CRUNCHBASE_SCRAPER_URL=http://crunchbase_api:8003
      - TRACXN_SCRAPER_URL=http://tracxn_api:8008

  # ==========================================================================
  # Celery Worker Production Overrides
  # ==========================================================================
  celery-worker:
    environment:
      - DEBUG=0
      - PYTHONUNBUFFERED=1
      - CELERY_CONCURRENCY=4

      # Database - Private Network
      - DB_HOST=marketnavigator-v2
      - DB_PORT=5432
      - DB_NAME=postgres
      - DB_USER=root
      - DB_PASSWORD=AZ6t2MguosDdJ8oCval6B7bU

      # Redis
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0

      # S3
      - USE_S3=True
      - AWS_ACCESS_KEY_ID=minioadmin
      - AWS_SECRET_ACCESS_KEY=minioadmin123
      - AWS_STORAGE_BUCKET_NAME=marketnavigator-files
      - AWS_S3_ENDPOINT_URL=http://minio:9000

      # AI Keys
      - METIS_API_KEY=${METIS_API_KEY:-tpsg-dzOOSs20K2g3Bbp6rpDXAYpMDD9EydX}
      - METIS_BASE_URL=https://api.metisai.ir/openai/v1
      - METIS_MODEL=gpt-4o-mini
      - LIARA_API_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJrZXkiOiI2OTE4MzY0YjFmYjc4MTI5ZDI5MjhiYjgiLCJ0eXBlIjoiYWlfa2V5IiwiaWF0IjoxNzYzMTk0NDQzfQ.SCiUegAiSgB1sscxzNh4TWLZ7KntbZRLk2HGjeA3j0k
      - LIARA_BASE_URL=https://ai.liara.ir/api/6918348a8376cb0a3e18fdef/v1
      - LIARA_MODEL=google/gemini-2.5-flash
      - SECRET_KEY=${SECRET_KEY:-change-this-to-a-strong-secret-key}

      # Scrapers
      - CRUNCHBASE_SCRAPER_URL=http://crunchbase_api:8003
      - TRACXN_SCRAPER_URL=http://tracxn_api:8008

  # ==========================================================================
  # Celery Beat Production Overrides
  # ==========================================================================
  celery-beat:
    environment:
      - DEBUG=0
      - PYTHONUNBUFFERED=1

      # Database - Private Network
      - DB_HOST=marketnavigator-v2
      - DB_PORT=5432
      - DB_NAME=postgres
      - DB_USER=root
      - DB_PASSWORD=AZ6t2MguosDdJ8oCval6B7bU

      # Redis
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - SECRET_KEY=${SECRET_KEY:-change-this-to-a-strong-secret-key}

  # ==========================================================================
  # Frontend Production Overrides
  # ==========================================================================
  frontend:
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=https://marketnavigator.ir
      - NEXT_PUBLIC_WS_URL=wss://marketnavigator.ir
    # Remove volume mount for production (use built image)
    volumes: []

  # ==========================================================================
  # Flower - Disable external access in production
  # ==========================================================================
  flower:
    ports: [] # Don't expose externally; access via nginx if needed

  # ==========================================================================
  # MinIO - Disable console external access in production
  # ==========================================================================
  minio:
    ports:
      - "9000:9000" # Keep API accessible for file access
      # Remove 9001 console port for security

volumes:
  letsencrypt_data:
